<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alkanes数据统计</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#0F172A',
                        'dark-card': '#1E293B',
                        'dark-hover': '#334155',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .stat-card {
                @apply bg-dark-card rounded-xl p-5 shadow-lg transition-all duration-300 hover:shadow-primary/20 hover:translate-y-[-4px] border border-gray-700/50;
            }
            .section-title {
                @apply text-xl font-bold mb-6 flex items-center text-white;
            }
            .param-module {
                @apply bg-dark-card rounded-xl p-6 shadow-lg border border-gray-700/50 mb-6;
            }
            .stat-value {
                @apply text-2xl md:text-3xl font-bold mt-1;
            }
            .divider {
                @apply border-t border-gray-700 my-6;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none;
            }
            .calc-item {
                @apply bg-dark p-4 rounded-lg border border-gray-700;
            }
            .calc-label {
                @apply text-gray-400 text-sm mb-3;
            }
            .calc-operation {
                @apply flex flex-wrap items-center;
            }
            .calc-value {
                @apply text-gray-300 whitespace-nowrap;
            }
            .calc-operator {
                @apply text-gray-400 mx-2;
            }
            .calc-result {
                @apply font-bold text-accent ml-auto whitespace-nowrap;
            }
            .result-sub {
                @apply text-sm text-gray-300 ml-2;
            }
            .countdown {
                @apply inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary/20 text-primary font-medium mr-2;
            }
            .alert-highlight {
                @apply animate-pulse ring-2 ring-green-500;
            }
            .btn-pulse {
                @apply animate-pulse;
            }
            .audio-visualizer {
                @apply h-2 bg-gray-700 rounded-full overflow-hidden mt-2 hidden;
            }
            .audio-visualizer-bar {
                @apply h-full bg-primary w-1 inline-block animate-pulse;
            }
            /* 表格相关样式 */
            .data-table-container {
                @apply bg-dark-card rounded-xl shadow-lg border border-gray-700/50 overflow-hidden;
            }
            .table-header {
                @apply p-5 border-b border-gray-700 cursor-pointer transition-all;
            }
            .table-content {
                @apply max-h-96 overflow-y-auto transition-all duration-300 ease-in-out;
            }
            .data-table {
                @apply w-full text-sm text-left;
            }
            .data-table th {
                @apply px-6 py-4 bg-dark/50 font-semibold text-gray-300 sticky top-0 z-10;
            }
            .data-table td {
                @apply px-6 py-4 border-t border-gray-800 hover:bg-dark/30 transition;
            }
            .table-row-odd {
                @apply bg-dark/10;
            }
            .sort-indicator {
                @apply ml-2 text-xs text-gray-400;
            }
        }
    </style>
</head>
<body class="bg-dark text-gray-200 font-sans min-h-screen">
    <!-- 音频元素用于播放通知声音 - 兼容Chrome的设置 -->
    <audio id="alertSound" preload="auto" playsinline>
         <source src="https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- 备用音频元素，解决某些浏览器缓存问题 -->
    <audio id="alertSoundFallback" preload="auto" playsinline >
        <source src="https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- 顶部导航栏 -->
    <header class="bg-dark-card/80 backdrop-blur-md border-b border-gray-800 sticky top-0 z-30">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center mr-3">
                        <i class="fa fa-bar-chart text-primary text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">Alkanes数据统计</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- 倒计时显示、监控按钮和测试音频按钮 -->
                    <div id="countdownContainer" class="flex items-center">
                        <span id="countdown" class="countdown">20</span>
                        <button id="monitorBtn" class="bg-secondary hover:bg-secondary/80 text-white transition px-3 py-1.5 rounded-lg flex items-center text-sm">
                            <i class="fa fa-play mr-1.5"></i>
                            <span>开始监控</span>
                        </button>
                        <!-- 测试音频按钮 -->
                        <button id="testAudioBtn" class="bg-accent hover:bg-accent/80 text-white transition px-3 py-1.5 rounded-lg flex items-center text-sm ml-2">
                            <i class="fa fa-volume-up mr-1.5"></i>
                            <span>测试声音</span>
                        </button>
                    </div>
                    <button id="refreshBtn" class="bg-dark-hover hover:bg-gray-600/50 text-white transition px-4 py-2 rounded-lg flex items-center">
                        <i class="fa fa-refresh mr-2"></i>
                        <span>刷新数据</span>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center">
                        <i class="fa fa-user text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 加载状态 -->
    <div id="loading" class="fixed inset-0 bg-dark/80 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-card p-6 rounded-xl shadow-2xl flex flex-col items-center border border-gray-700">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-lg font-medium">正在获取并分析数据...</p>
            <p class="text-sm text-gray-400 mt-2" id="loadingProgress">正在尝试连接服务器...</p>
        </div>
    </div>

    <!-- 错误提示 -->
    <div id="errorAlert" class="container mx-auto px-4 mt-4 hidden">
        <div class="bg-red-900/30 border border-red-800/50 text-red-400 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">数据获取失败! </strong>
            <span class="block sm:inline" id="errorMessage">请确保网络连接正常</span>
            <button onclick="document.getElementById('errorAlert').classList.add('hidden')" class="absolute top-0 bottom-0 right-0 px-4 py-3 hover:bg-red-900/20 rounded-r-lg transition">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 音频错误提示 -->
    <div id="audioErrorAlert" class="container mx-auto px-4 mt-4 hidden">
        <div class="bg-orange-900/30 border border-orange-800/50 text-orange-400 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">音频播放失败! </strong>
            <span class="block sm:inline" id="audioErrorMessage">请检查浏览器声音设置</span>
            <button onclick="document.getElementById('audioErrorAlert').classList.add('hidden')" class="absolute top-0 bottom-0 right-0 px-4 py-3 hover:bg-orange-900/20 rounded-r-lg transition">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 通知权限提示 -->
    <div id="notificationPermissionAlert" class="container mx-auto px-4 mt-4 hidden">
        <div class="bg-blue-900/30 border border-blue-800/50 text-blue-400 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">通知权限请求! </strong>
            <span class="block sm:inline" id="notificationPermissionMessage">请允许浏览器通知以接收实时提醒</span>
            <button onclick="document.getElementById('notificationPermissionAlert').classList.add('hidden')" class="absolute top-0 bottom-0 right-0 px-4 py-3 hover:bg-blue-900/20 rounded-r-lg transition">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 音频测试区域-->
    <div id="audioTestArea" class="container mx-auto px-4 mt-4 hidden">
    </div>

    <!-- 回报率高的提示 -->
    <div id="highReturnAlert" class="fixed top-20 right-4 bg-green-900/80 backdrop-blur-md border border-green-800/50 text-green-300 px-4 py-3 rounded-lg shadow-lg z-40 hidden transform transition-all duration-300 translate-x-full">
        <div class="flex items-center">
            <i class="fa fa-bell text-green-400 mr-2 text-xl"></i>
            <div>
                <p class="font-bold">高回报率警报</p>
                <p class="text-sm">回报率超过50%，建议关注</p>
            </div>
            <button onclick="hideHighReturnAlert()" class="ml-4 text-green-400 hover:text-green-300">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 核心数据概览卡片 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-5 mb-8">
            <div class="stat-card">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-gray-400 text-sm">BTC价格 (USD)</p>
                        <p class="stat-value text-primary" id="usdValue">--</p>
                    </div>
                    <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                        <i class="fa fa-usd text-primary"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-xs">来自价格API</p>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-gray-400 text-sm">内存池交易数</p>
                        <p class="stat-value text-primary" id="ntxValue">--</p>
                    </div>
                    <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                        <i class="fa fa-exchange text-primary"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-xs">nTx数据</p>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-gray-400 text-sm">上链阈值</p>
                        <p class="stat-value text-secondary" id="feeThreshold">--</p>
                    </div>
                    <div class="w-10 h-10 rounded-lg bg-secondary/20 flex items-center justify-center">
                        <i class="fa fa-balance-scale text-secondary"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-xs">来自feeRange数据</p>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-gray-400 text-sm">符合条件记录数</p>
                        <p class="stat-value text-secondary" id="qualifiedCount">--</p>
                    </div>
                    <div class="w-10 h-10 rounded-lg bg-secondary/20 flex items-center justify-center">
                        <i class="fa fa-check-circle text-secondary"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-xs">fee ≥ 阈值的记录</p>
            </div>

            <div class="stat-card">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-gray-400 text-sm">柴油价格(sats)</p>
                        <p class="stat-value text-accent" id="chaiyouPrice">--</p>
                    </div>
                    <div class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center">
                        <i class="fa fa-fuel text-accent"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-xs">来自市场API</p>
            </div>
        </div>

        <!-- 主要内容区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：fee分布数据展示和参数模块 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 数据参数模块 -->
                <div class="param-module">
                    <h2 class="section-title">
                        <div class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center mr-3">
                            <i class="fa fa-sliders text-primary"></i>
                        </div>
                        数据参数设置
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 数量输入 -->
                        <div class="calc-item">
                            <p class="calc-label">Mint数量</p>
                            <input type="number" id="quantity" value="25" class="w-full bg-dark-card border border-gray-600 rounded-lg px-3 py-2 text-center text-white input-focus">
                            <p class="text-xs text-gray-500 mt-2">用于分配比例计算和实际成本计算的基础数量</p>
                        </div>

                        <!-- 上链阈值输入（保留两位小数） -->
                        <div class="calc-item">
                            <p class="calc-label">上链阈值</p>
                            <input type="number" id="chainThreshold" value="1.00" step="0.01" class="w-full bg-dark-card border border-gray-600 rounded-lg px-3 py-2 text-center text-white input-focus">
                            <p class="text-xs text-gray-500 mt-2">用于计算实际成本的阈值参数，精确到两位小数</p>
                        </div>
                    </div>
                </div>

                <!-- fee分布数据展示 -->
                <div class="bg-dark-card rounded-xl overflow-hidden shadow-lg border border-gray-700/50">
                    <div class="p-5 border-b border-gray-700">
                        <h2 class="section-title">
                            <div class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center mr-3">
                                <i class="fa fa-pie-chart text-primary"></i>
                            </div>
                            费率分布情况
                        </h2>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                            <div class="bg-dark p-3 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <p class="text-xs text-gray-400">0-1区间</p>
                                <p class="font-bold text-primary mt-1" id="range0-1">--</p>
                            </div>
                            <div class="bg-dark p-3 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <p class="text-xs text-gray-400">1-2区间</p>
                                <p class="font-bold text-primary mt-1" id="range1-2">--</p>
                            </div>
                            <div class="bg-dark p-3 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <p class="text-xs text-gray-400">2-3区间</p>
                                <p class="font-bold text-primary mt-1" id="range2-3">--</p>
                            </div>
                            <div class="bg-dark p-3 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <p class="text-xs text-gray-400">3以上区间</p>
                                <p class="font-bold text-primary mt-1" id="range3plus">--</p>
                            </div>
                            <div class="bg-dark p-3 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <p class="text-xs text-gray-400">无效值</p>
                                <p class="font-bold text-primary mt-1" id="rangeInvalid">--</p>
                            </div>
                            <div class="bg-dark p-3 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <p class="text-xs text-gray-400">无fee字段</p>
                                <p class="font-bold text-primary mt-1" id="rangeNoFee">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新增：API数据表格展示，可展开/折叠 -->
                <div class="data-table-container">
                    <div id="tableHeader" class="table-header flex justify-between items-center">
                        <h2 class="section-title mb-0">
                            <div class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center mr-3">
                                <i class="fa fa-table text-primary"></i>
                            </div>
                            原始数据列表
                        </h2>
                        <div class="flex items-center">
                            <span class="text-sm text-gray-400 mr-2">显示前300条数据</span>
                            <i id="tableToggleIcon" class="fa fa-chevron-down text-gray-400 transition-transform duration-300"></i>
                        </div>
                    </div>
                    <div id="tableContent" class="table-content opacity-0 max-h-0">
                        <table class="data-table" id="apiDataTable">
                            <thead>
                                <tr>
                                    <th>自增ID</th>
                                    <th>
                                        费率(fee)
                                        <span class="sort-indicator">
                                            <i class="fa fa-sort-desc"></i> 降序
                                        </span>
                                    </th>
                                    <th>txid</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- 数据将通过JavaScript动态填充 -->
                                <tr>
                                    <td colspan="3" class="text-center py-8 text-gray-500">
                                        <i class="fa fa-spinner fa-spin mr-2"></i> 加载数据中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- 右侧：套利计算结果 -->
            <div class="space-y-6">
                <div class="bg-dark-card rounded-xl overflow-hidden shadow-lg border border-gray-700/50">
                    <div class="p-5 border-b border-gray-700">
                        <h2 class="section-title">
                            <div class="w-8 h-8 rounded-lg bg-accent/20 flex items-center justify-center mr-3">
                                <i class="fa fa-calculator text-accent"></i>
                            </div>
                            套利计算结果
                        </h2>
                    </div>
                    <div class="p-5">
                        <div class="space-y-4">
                            <!-- 分配比例 -->
                            <div class="calc-item">
                                <p class="calc-label">分配比例</p>
                                <div class="calc-operation">
                                    <span id="quantityDisplay" class="calc-value">25</span>
                                    <span class="calc-operator">/</span>
                                    <span id="distributionDenominator" class="calc-value">--</span>
                                    <span class="calc-operator">=</span>
                                    <span id="distributionRatio" class="calc-result min-w-[80px] text-right">--</span>
                                </div>
                            </div>

                            <!-- 获得柴油数量和价值 -->
                            <div class="calc-item">
                                <p class="calc-label">获得柴油数量及价值</p>
                                <div class="calc-operation">
                                    <span id="ratioDisplay" class="calc-value">--</span>
                                    <span class="calc-operator">×</span>
                                    <span class="calc-value">3.125</span>
                                    <span class="calc-operator">=</span>
                                    <span id="dieselAmount" class="calc-result">--</span>
                                    <span class="result-sub">(<span id="chaiyouValue" class="text-accent">-- USD</span>)</span>
                                </div>
                            </div>

                            <!-- 实际成本和USD成本 -->
                            <div class="calc-item">
                                <p class="calc-label">实际成本及USD成本</p>
                                <div class="calc-operation">
                                    <span id="quantityDisplay2" class="calc-value">25</span>
                                    <span class="calc-operator">×</span>
                                    <span class="calc-value">149</span>
                                    <span class="calc-operator">×</span>
                                    <span id="thresholdDisplay" class="calc-value">1.00</span>
                                    <span class="calc-operator">=</span>
                                    <span id="actualCost" class="calc-result">-- sats</span>
                                    <span class="result-sub">(<span id="usdCost" class="text-accent">-- USD</span>)</span>
                                </div>
                            </div>

                            <!-- 预估利润 -->
                            <div class="calc-item bg-gradient-to-r from-accent/10 to-primary/10 border-accent/30">
                                <p class="calc-label font-medium text-accent">预估利润</p>
                                <div class="calc-operation">
                                    <span id="profitValue" class="calc-value">--</span>
                                    <span class="calc-operator">-</span>
                                    <span id="costValue" class="calc-value">--</span>
                                    <span class="calc-operator">=</span>
                                    <span id="finalProfit" class="calc-result font-bold min-w-[80px] text-right">-- USD</span>
                                </div>
                            </div>

                            <!-- 回报率 -->
                            <div class="calc-item bg-gradient-to-r from-secondary/10 to-primary/10 border-secondary/30" id="returnRateContainer">
                                <p class="calc-label font-medium text-secondary">回报率</p>
                                <div class="calc-operation">
                                    <span id="finalProfitDisplay" class="calc-value">--</span>
                                    <span class="calc-operator">/</span>
                                    <span id="usdCostDisplay" class="calc-value">--</span>
                                    <span class="calc-operator">×</span>
                                    <span class="calc-value">100%</span>
                                    <span class="calc-operator">=</span>
                                    <span id="returnRate" class="calc-result font-bold min-w-[80px] text-right">-- %</span>
                                </div>
                            </div>

                            <button id="refreshBtn2" class="w-full bg-gradient-to-r from-primary to-blue-600 hover:opacity-90 text-white transition py-3 rounded-lg flex items-center justify-center font-medium">
                                <i class="fa fa-refresh mr-2"></i>
                                <span>刷新数据</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark-card border-t border-gray-800 py-6 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-center md:text-left mb-4 md:mb-0">
                    <p class="text-gray-500 text-sm">© 2023 符文数据统计</p>
                    <p class="text-gray-600 text-xs mt-1">实时数据更新与分析</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="w-8 h-8 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-primary hover:bg-dark-hover transition">
                        <i class="fa fa-github"></i>
                    </a>
                    <a href="#" class="w-8 h-8 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-primary hover:bg-dark-hover transition">
                        <i class="fa fa-twitter"></i>
                    </a>
                    <a href="#" class="w-8 h-8 rounded-full bg-dark flex items-center justify-center text-gray-400 hover:text-primary hover:bg-dark-hover transition">
                        <i class="fa fa-linkedin"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // 确保DOM完全加载后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，初始化脚本');

            // 辅助函数：格式化数字 - 小数保留两位，整数不变
            function formatNumber(num) {
                if (num === null || num === undefined) return '--';
                if (typeof num !== 'number') {
                    try {
                        num = parseFloat(num);
                    } catch (e) {
                        return '--';
                    }
                }
                // 检查是否为整数
                return Number.isInteger(num) ? num.toString() : num.toFixed(2);
            }

            // 格式化百分比
            function formatPercentage(num) {
                if (num === null || num === undefined) return '-- %';
                return `${num.toFixed(2)}%`;
            }

            // 全局变量
            let currentData = {
                feeRanges: {},
                feeGeThresholdCount: 0,
                totalFirst: 0,
                firstNtxValue: null,
                feeThreshold: null,
                usdValue: null,
                chaiyouPrice: null,
                rawApiData: [] // 新增：存储原始API数据
            };

            // 自动刷新相关变量
            const AUTO_REFRESH_INTERVAL = 20; // 自动刷新间隔（秒）
            let countdownTimer = null;
            let remainingTime = AUTO_REFRESH_INTERVAL;
            let isMonitoring = false; // 监控状态标志
            let lastReturnRate = null; // 记录上次回报率，用于比较
            let soundEnabled = true; // 声音默认启用
            let userInteracted = false; // 记录用户是否已与页面交互（解决Chrome自动播放限制）
            let notificationsEnabled = false; // 通知是否已启用
            let audioContext = null; // Web Audio API上下文

            // 音频队列管理
            const audioQueue = [];
            let isProcessingAudioQueue = false;

            // 表格相关变量
            let tableExpanded = false; // 表格展开状态

            // 配置Vercel代理路径（替换原来的Python本地代理）
            // 注意：不需要指定完整URL，Vercel会自动处理相对路径
            const api1Url = '/api/proxy/runes';
            const api2Url = '/api/proxy/fees';
            const api3Url = '/api/proxy/prices';
            const api4Url = '/api/proxy/market';

            // 获取音频元素和按钮元素
            const alertSound = document.getElementById('alertSound');
            const alertSoundFallback = document.getElementById('alertSoundFallback');
            const testAudioBtn = document.getElementById('testAudioBtn');
            const audioVisualizer = document.getElementById('audioVisualizer');
            const audioTestArea = document.getElementById('audioTestArea');

            // 初始化时请求通知权限
            requestNotificationPermission();

            // 为页面添加点击事件监听器，用于处理Chrome的自动播放限制
            document.body.addEventListener('click', handleUserInteraction);
            document.body.addEventListener('touchstart', handleUserInteraction);

            // 表格展开/折叠功能
            const tableHeader = document.getElementById('tableHeader');
            const tableContent = document.getElementById('tableContent');
            const tableToggleIcon = document.getElementById('tableToggleIcon');

            if (tableHeader) {
                tableHeader.addEventListener('click', toggleTable);
            }

            // 处理用户交互，获取音频播放权限
            function handleUserInteraction() {
                if (!userInteracted) {
                    userInteracted = true;
                    console.log('用户已与页面交互，获得音频播放权限');

                    // 尝试预加载音频
                    try {
                        // 初始化Web Audio API
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();

                        // 加载主音频
                        alertSound.load();
                        // 加载备用音频
                        alertSoundFallback.load();

                        // 显示音频测试区域
                        audioTestArea.classList.remove('hidden');
                    } catch (e) {
                        console.log('音频初始化失败:', e);
                    }
                }
            }

            // 切换表格展开/折叠状态
            function toggleTable() {
                tableExpanded = !tableExpanded;
                const tableBody = document.getElementById('tableBody');

                if (tableExpanded) {
                    // 展开表格
                    tableContent.classList.remove('max-h-0', 'opacity-0');
                    tableContent.classList.add('max-h-96', 'opacity-100');
                    tableToggleIcon.classList.add('rotate-180');

                    // 如果还没有数据，尝试加载
                    if (currentData.rawApiData.length === 0 && tableBody.innerHTML.includes('加载数据中')) {
                        fetchApiDataForTable();
                    }
                } else {
                    // 折叠表格
                    tableContent.classList.remove('max-h-96', 'opacity-100');
                    tableContent.classList.add('max-h-0', 'opacity-0');
                    tableToggleIcon.classList.remove('rotate-180');
                }
            }

            // 单独获取表格数据
            async function fetchApiDataForTable() {
                try {
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center py-8 text-gray-500">
                                <i class="fa fa-spinner fa-spin mr-2"></i> 加载数据中...
                            </td>
                        </tr>
                    `;

                    const data = await fetchApiData(api1Url);
                    currentData.rawApiData = data || [];
                    populateTableData();
                } catch (error) {
                    console.error('获取表格数据失败:', error);
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center py-8 text-red-400">
                                <i class="fa fa-exclamation-triangle mr-2"></i> 数据加载失败
                            </td>
                        </tr>
                    `;
                }
            }

            // 填充表格数据
            function populateTableData() {
                const tableBody = document.getElementById('tableBody');
                const data = currentData.rawApiData || [];

                // 按fee降序排序，处理无效值
                const sortedData = [...data].sort((a, b) => {
                    // 解析fee值，无效值排在后面
                    const feeA = a && a.fee ? parseFloat(a.fee) : -Infinity;
                    const feeB = b && b.fee ? parseFloat(b.fee) : -Infinity;
                    return feeB - feeA; // 降序排列
                });

                // 取前300条
                const displayData = sortedData.slice(0, 300);

                if (displayData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center py-8 text-gray-500">
                                <i class="fa fa-info-circle mr-2"></i> 没有可用数据
                            </td>
                        </tr>
                    `;
                    return;
                }

                // 构建表格内容
                let tableHtml = '';
                displayData.forEach((item, index) => {
                    const id = index + 1; // 自增ID
                    const fee = item && item.fee ? item.fee : '无数据';
                    const txid = item && item.txid ? item.txid : '无数据';

                    // 格式化fee值
                    let formattedFee = fee;
                    if (typeof fee === 'string') {
                        try {
                            const num = parseFloat(fee);
                            formattedFee = isNaN(num) ? '无效值' : formatNumber(num);
                        } catch (e) {
                            formattedFee = '无效值';
                        }
                    } else if (typeof fee === 'number') {
                        formattedFee = formatNumber(fee);
                    }

                    // 为奇数行添加背景色
                    const rowClass = index % 2 === 0 ? '' : 'table-row-odd';

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td>${id}</td>
                            <td class="${formattedFee === '无效值' || formattedFee === '无数据' ? 'text-red-400' : ''}">
                                ${formattedFee}
                            </td>
                            <td class="font-mono text-xs truncate max-w-[200px] md:max-w-none" title="${txid}">
                                ${txid}
                            </td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = tableHtml;
            }

            // 请求通知权限
            function requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(function(permission) {
                        console.log('通知权限状态:', permission);
                        if (permission === 'granted') {
                            notificationsEnabled = true;
                        } else if (permission === 'denied') {
                            // 权限被拒绝，显示提示
                            showNotificationPermissionAlert('通知权限已被拒绝，请在浏览器设置中启用通知以接收提醒');
                        } else {
                            // 权限未确定，显示提示
                            showNotificationPermissionAlert('请允许通知权限以接收实时提醒');
                        }
                    });
                } else {
                    console.log('浏览器不支持通知功能');
                }
            }

            // 显示通知权限提示
            function showNotificationPermissionAlert(message) {
                const alertElement = document.getElementById('notificationPermissionAlert');
                const messageElement = document.getElementById('notificationPermissionMessage');
                messageElement.textContent = message;
                alertElement.classList.remove('hidden');

                // 8秒后自动隐藏
                setTimeout(() => {
                    alertElement.classList.add('hidden');
                }, 8000);
            }

            // 显示浏览器通知
            function showBrowserNotification(title, body) {
                if (!('Notification' in window)) {
                    console.log('浏览器不支持通知');
                    return;
                }

                if (Notification.permission !== 'granted') {
                    console.log('通知权限未授予');
                    requestNotificationPermission();
                    return;
                }

                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: 'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/fonts/fontawesome-webfont.woff2',
                        vibrate: [200, 100, 200],
                        requireInteraction: false
                    });

                    notification.onclick = function() {
                        window.focus();
                        this.close();
                    };

                    setTimeout(() => {
                        notification.close();
                    }, 5000);

                } catch (error) {
                    console.error('显示通知失败:', error);
                }
            }

            // 设置音频可视化效果
            function setupAudioVisualization(audioElement) {
                try {
                    // 确保音频上下文已初始化
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // 创建音频源节点
                    const source = audioContext.createMediaElementSource(audioElement);
                    const analyser = audioContext.createAnalyser();

                    // 连接音频处理链
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);

                    analyser.fftSize = 32;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    // 更新可视化效果的动画函数
                    function updateVisualizer() {
                        requestAnimationFrame(updateVisualizer);
                        analyser.getByteFrequencyData(dataArray);

                        const bars = document.querySelectorAll('.audio-visualizer-bar');
                        bars.forEach((bar, i) => {
                            if (i < dataArray.length) {
                                const height = (dataArray[i] / 255) * 100;
                                bar.style.height = `${height}%`;
                            }
                        });
                    }

                    // 显示可视化区域并开始动画
                    audioVisualizer.classList.remove('hidden');
                    updateVisualizer();

                    // 音频结束后隐藏可视化效果
                    audioElement.onended = function() {
                        audioVisualizer.classList.add('hidden');
                    };

                } catch (error) {
                    console.error('设置音频可视化失败:', error);
                    showAudioError('音频可视化初始化失败');
                }
            }

            // 添加测试音频按钮功能
            if (testAudioBtn) {
                testAudioBtn.addEventListener('click', function() {
                    console.log('测试音频按钮被点击1');

                    // 检查用户是否已交互
                    if (!userInteracted) {
                        showAudioError('请先点击页面任意位置以获取音频播放权限（Chrome浏览器限制）');
                        return;
                    }
                        console.log('测试音频按钮被点击2');
                    // 播放测试声音
                    playTestSound();
                });
            }

            // 播放测试声音
            function playTestSound() {
                // 显示测试区域
                audioTestArea.classList.remove('hidden');

                // 尝试播放声音，使用主音频和备用音频双重保险
                playAudio(alertSound, false, () => {
                    console.log('测试音频播放成功');
                    testAudioBtn.classList.add('btn-pulse');
                    setTimeout(() => {
                        testAudioBtn.classList.remove('btn-pulse');
                    }, 1000);

                    // 显示测试通知
                    showBrowserNotification('测试通知', '声音和通知功能正常工作');
                }, (error) => {
                    console.error('主音频播放失败，尝试备用音频:', error);

                    // 尝试备用音频
                    playAudio(alertSoundFallback, true, () => {
                        console.log('备用音频播放成功');
                        testAudioBtn.classList.add('btn-pulse');
                        setTimeout(() => testAudioBtn.classList.remove('btn-pulse'), 1000);

                        showBrowserNotification('测试通知', '声音和通知功能正常工作');
                    }, (fallbackError) => {
                        console.error('备用音频播放也失败:', fallbackError);

                        // 详细错误提示
                        let errorMsg = '';
                        if (fallbackError.name === 'NotAllowedError') {
                            errorMsg = '音频播放被浏览器阻止。请检查：1. 浏览器声音是否开启 2. 网站声音权限是否允许 3. 尝试刷新页面';
                        } else if (fallbackError.name === 'NotSupportedError') {
                            errorMsg = '浏览器不支持音频播放格式';
                        } else if (fallbackError.message.includes('Failed to fetch')) {
                            errorMsg = '音频文件加载失败，可能是网络问题';
                        } else {
                            errorMsg = `音频播放失败: ${fallbackError.message}`;
                        }

                        showAudioError(errorMsg);
                    });
                });
            }

            // 播放音频的通用函数
            function playAudio(audioElement, useFallback, onSuccess, onError) {
                // 确保音频元素存在
                if (!audioElement) {
                    onError && onError(new Error('音频元素不存在'));
                    return;
                }


                // 设置音频可视化
                // setupAudioVisualization(audioElement);

                // 配置音频
                audioElement.volume = 0.7;
                audioElement.currentTime = 0;
                console.log(audioElement)
                // 执行播放
                const playPromise = audioElement.play();
                console.log("执行了")
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('音频播放已开始');
                        onSuccess && onSuccess();
                    }).catch(error => {
                        onError && onError(error);
                    });
                }
            }

            // 显示音频错误信息
            function showAudioError(message) {
                const audioErrorAlert = document.getElementById('audioErrorAlert');
                const audioErrorMessage = document.getElementById('audioErrorMessage');
                audioErrorMessage.textContent = message;
                audioErrorAlert.classList.remove('hidden');

                // 10秒后自动隐藏（比之前更长，让用户有时间阅读）
                setTimeout(() => {
                    audioErrorAlert.classList.add('hidden');
                }, 10000);
            }

            // 初始化应用
            function initApp() {
                console.log('初始化应用');
                // 获取数据
                fetchAndProcessData();

                // 绑定监控按钮事件
                document.getElementById('monitorBtn').addEventListener('click', toggleMonitoring);

                // 绑定刷新按钮事件
                document.getElementById('refreshBtn').addEventListener('click', manualRefresh);
                document.getElementById('refreshBtn2').addEventListener('click', manualRefresh);

                // 绑定数量输入框事件
                document.getElementById('quantity').addEventListener('input', updateArbitrageCalculation);
                // 绑定上链阈值输入框事件
                document.getElementById('chainThreshold').addEventListener('input', updateArbitrageCalculation);
            }

            // 播放通知声音
            function playAlertSound() {
                // 检查是否满足播放条件
                if (!soundEnabled || !isMonitoring || !userInteracted) {
                    console.log('不满足播放条件，无法播放通知');
                    return;
                }

                playAudio(alertSound, false, () => {
                    console.log('通知声音播放成功');
                }, (error) => {
                    console.error('播放通知声音失败，尝试备用音频:', error);
                    // 尝试备用音频
                    playAudio(alertSoundFallback, true, () => {
                        console.log('备用通知声音播放成功');
                    }, (fallbackError) => {
                        console.error('备用通知声音也播放失败:', fallbackError);
                        showAudioError('无法播放通知声音，请检查浏览器设置');
                    });
                });
            }

            // 显示高回报率提示
            function showHighReturnAlert() {
                const alertElement = document.getElementById('highReturnAlert');
                if (alertElement) {
                    alertElement.classList.remove('hidden', 'translate-x-full');
                    alertElement.classList.add('translate-x-0');

                    // 显示浏览器通知
                    showBrowserNotification('高回报率警报', '回报率超过50%，建议关注');

                    // 播放提示音
                    playAlertSound();

                    // 5秒后自动隐藏
                    setTimeout(hideHighReturnAlert, 5000);
                }
            }

            // 隐藏高回报率提示
            function hideHighReturnAlert() {
                const alertElement = document.getElementById('highReturnAlert');
                if (alertElement) {
                    alertElement.classList.add('translate-x-full');
                    setTimeout(() => {
                        alertElement.classList.add('hidden');
                    }, 300);
                }
            }

            // 切换监控状态
            function toggleMonitoring() {
                const monitorBtn = document.getElementById('monitorBtn');
                const icon = monitorBtn.querySelector('i');
                const text = monitorBtn.querySelector('span');

                if (isMonitoring) {
                    // 暂停监控
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                    }
                    icon.className = 'fa fa-play mr-1.5';
                    text.textContent = '开始监控';
                    monitorBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    monitorBtn.classList.add('bg-secondary', 'hover:bg-secondary/80');
                } else {
                    // 开始监控
                    startCountdown();
                    icon.className = 'fa fa-pause mr-1.5';
                    text.textContent = '暂停监控';
                    monitorBtn.classList.remove('bg-secondary', 'hover:bg-secondary/80');
                    monitorBtn.classList.add('bg-red-600', 'hover:bg-red-700');

                    // 检查用户是否已交互，未交互则提示
                    if (!userInteracted) {
                        showAudioError('请点击页面任意位置以确保声音通知正常工作（Chrome浏览器限制）');
                    }

                    // 检查通知权限
                    if (!notificationsEnabled && 'Notification' in window) {
                        requestNotificationPermission();
                    }
                }

                isMonitoring = !isMonitoring;
            }

            // 启动倒计时
            function startCountdown() {
                // 清除现有计时器
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }

                // 更新显示
                updateCountdownDisplay();

                // 设置新计时器
                countdownTimer = setInterval(() => {
                    remainingTime--;

                    if (remainingTime <= 0) {
                        // 时间到，自动刷新
                        clearInterval(countdownTimer);
                        fetchAndProcessData().then(() => {
                            // 刷新完成后重新开始倒计时
                            remainingTime = AUTO_REFRESH_INTERVAL;
                            if (isMonitoring) { // 只有在监控状态下才继续倒计时
                                startCountdown();
                            }
                        });
                    } else {
                        // 更新倒计时显示
                        updateCountdownDisplay();
                    }
                }, 1000);
            }

            // 更新倒计时显示
            function updateCountdownDisplay() {
                const countdownElement = document.getElementById('countdown');
                countdownElement.textContent = remainingTime;

                // 添加数字变化动画
                countdownElement.classList.add('scale-110');
                setTimeout(() => {
                    countdownElement.classList.remove('scale-110');
                }, 200);
            }

            // 手动刷新数据
            function manualRefresh() {
                // 清除现有计时器
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }

                // 立即刷新数据
                fetchAndProcessData().then(() => {
                    // 刷新完成后重置倒计时
                    remainingTime = AUTO_REFRESH_INTERVAL;
                    updateCountdownDisplay();

                    // 如果处于监控状态，重新开始倒计时
                    if (isMonitoring) {
                        startCountdown();
                    }
                });
            }

            // 显示加载状态
            function showLoading() {
                document.getElementById('loading').classList.remove('hidden');
            }

            // 更新加载进度
            function updateLoadingProgress(message) {
                document.getElementById('loadingProgress').textContent = message;
            }

            // 隐藏加载状态
            function hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }

            // 显示错误信息
            function showError(message) {
                const errorAlert = document.getElementById('errorAlert');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = message;
                errorAlert.classList.remove('hidden');
            }

            // 隐藏错误信息
            function hideError() {
                document.getElementById('errorAlert').classList.add('hidden');
            }

            // 带超时的fetch函数
            async function fetchWithTimeout(url, options = {}, timeout = 10000) {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('请求超时')), timeout)
                    )
                ]);
            }

            // 获取并处理数据
            async function fetchAndProcessData() {
                try {
                    showLoading();
                    hideError();
                    updateLoadingProgress('正在从代理服务器获取数据...');

                    try {
                        // 尝试通过Vercel代理获取所有API数据
                        const [api1Data, api2Data, api3Data, api4Data] = await Promise.all([
                            fetchApiData(api1Url),
                            fetchApiData(api2Url),
                            fetchApiData(api3Url),
                            fetchMarketData(api4Url)
                        ]);

                        // 保存原始API数据
                        currentData.rawApiData = api1Data || [];

                        // 如果表格已展开，更新表格数据
                        if (tableExpanded) {
                            populateTableData();
                        }

                        // 分析数据
                        const { ntxValue, feeThreshold } = analyzeSecondApi(api2Data);
                        const { feeRanges, feeGeThresholdCount, totalFirst } = analyzeFirstApi(api1Data, feeThreshold);
                        const usdValue = analyzeThirdApi(api3Data);
                        const chaiyouPrice = analyzeFourthApi(api4Data);

                        // 保存当前数据
                        currentData = {
                            ...currentData,
                            feeRanges,
                            feeGeThresholdCount,
                            totalFirst,
                            firstNtxValue: ntxValue,
                            feeThreshold,
                            usdValue,
                            chaiyouPrice
                        };

                        // 更新UI
                        updateUI();
                        updateArbitrageCalculation();

                    } catch (error) {
                        console.error(`获取数据失败:`, error);

                        // 提供更详细的错误原因和解决方案
                        let detailedMessage = "通过Vercel代理获取数据失败，可能的原因：\n";
                        detailedMessage += "- 代理配置错误\n";
                        detailedMessage += "- 源API服务器暂时不可用\n\n";
                        detailedMessage += "请尝试：\n";
                        detailedMessage += "- 检查Vercel部署是否成功\n";
                        detailedMessage += "- 检查API代理配置\n";
                        detailedMessage += "- 查看Vercel部署日志";

                        throw new Error(detailedMessage);
                    }

                } catch (error) {
                    console.error('处理数据时出错:', error);
                    showError(`获取数据失败: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }

            // 获取API数据
            // 修改fetchApiData函数，添加更详细的错误信息
            async function fetchApiData(url) {
                try {
                    const response = await fetchWithTimeout(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                        },
                        mode: 'cors',
                        cache: 'no-cache'
                    });

                    if (!response.ok) {
                        // 获取详细的错误响应内容
                        let errorDetails = await response.text();
                        try {
                            errorDetails = JSON.parse(errorDetails);
                        } catch (e) {
                            // 不是JSON格式的错误
                        }

                        throw new Error(`HTTP错误 ${response.status}: ${JSON.stringify(errorDetails)}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`获取 ${url} 数据失败:`, error);
                    // 根据错误类型提供更具体的信息
                    if (error.message.includes('Failed to fetch')) {
                        throw new Error(`无法连接到 ${url}，请检查网络连接和代理配置`);
                    } else if (error.message.includes('请求超时')) {
                        throw new Error(`请求 ${url} 超时，请检查API响应速度`);
                    }
                    throw error;
                }
            }

            // 获取市场数据（POST请求）
            async function fetchMarketData(url) {
                try {
                    const payload = {
                        "alkanesId": "2:0",
                        "page": 1,
                        "size": 1,
                        "orderType": 1,
                        "sellerAddress": ""
                    };

                    const response = await fetchWithTimeout(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json, text/plain, */*',
                        },
                        body: JSON.stringify(payload),
                        mode: 'cors',
                        cache: 'no-cache'
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error(`资源未找到 (404)`);
                        } else if (response.status === 500) {
                            const errorData = await response.json();
                            throw new Error(`服务器错误: ${errorData.error || '未知错误'}`);
                        } else {
                            throw new Error(`HTTP错误，状态码: ${response.status}`);
                        }
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`获取 ${url} 数据失败:`, error);
                    throw error;
                }
            }

            // 分析第一个API数据
            function analyzeFirstApi(data, feeThreshold) {
                if (!data || !Array.isArray(data)) {
                    throw new Error("第一个API数据无效或不是列表格式");
                }

                const totalFirst = data.length;
                const feeRanges = {
                    '0-1': 0,
                    '1-2': 0,
                    '2-3': 0,
                    '3以上': 0,
                    '无效值': 0,
                    '无fee字段': 0
                };
                let feeGeThresholdCount = 0;

                for (const item of data) {
                    if (item && typeof item === 'object' && 'fee' in item) {
                        try {
                            const fee = parseFloat(item.fee);

                            // 统计区间分布
                            if (fee < 1) {
                                feeRanges['0-1']++;
                            } else if (fee < 2) {
                                feeRanges['1-2']++;
                            } else if (fee < 3) {
                                feeRanges['2-3']++;
                            } else {
                                feeRanges['3以上']++;
                            }

                            // 统计大于等于阈值的数据
                            if (feeThreshold !== null && fee >= feeThreshold) {
                                feeGeThresholdCount++;
                            }
                        } catch (error) {
                            feeRanges['无效值']++;
                        }
                    } else {
                        feeRanges['无fee字段']++;
                    }
                }

                return { feeRanges, feeGeThresholdCount, totalFirst };
            }

            // 分析第二个API数据
            function analyzeSecondApi(data) {
                if (!data || !Array.isArray(data)) {
                    throw new Error("第二个API数据无效或不是列表格式");
                }

                let ntxValue = null;
                let feeThreshold = null;

                if (data.length > 0) {
                    const firstItem = data[0];

                    // 获取nTx值
                    if (firstItem && typeof firstItem === 'object' && 'nTx' in firstItem) {
                        try {
                            ntxValue = parseInt(firstItem.nTx, 10);
                        } catch (error) {
                            // 忽略无效值
                        }
                    }

                    // 提取feeRange第一条数据及其数值作为阈值
                    if (firstItem && typeof firstItem === 'object' && 'feeRange' in firstItem) {
                        const feeRange = firstItem.feeRange;
                        let firstFeeRangeItem = null;

                        if (Array.isArray(feeRange) && feeRange.length > 0) {
                            firstFeeRangeItem = feeRange[0];
                        } else if (feeRange && typeof feeRange === 'object') {
                            firstFeeRangeItem = feeRange;
                        }

                        // 尝试从feeRange第一条数据中提取数值作为阈值
                        if (firstFeeRangeItem && typeof firstFeeRangeItem === 'object') {
                            const valueKeys = ['min', 'max', 'avg', 'median', 'value'];
                            for (const key of valueKeys) {
                                if (key in firstFeeRangeItem) {
                                    try {
                                        // 确保阈值保留两位小数
                                        feeThreshold = parseFloat(firstFeeRangeItem[key]).toFixed(2);
                                        // 同步更新上链阈值输入框
                                        document.getElementById('chainThreshold').value = feeThreshold;
                                        break;
                                    } catch (error) {
                                        continue;
                                    }
                                }
                            }
                        } else if (typeof firstFeeRangeItem === 'number') {
                            // 确保阈值保留两位小数
                            feeThreshold = firstFeeRangeItem.toFixed(2);
                            // 同步更新上链阈值输入框
                            document.getElementById('chainThreshold').value = feeThreshold;
                        }
                    }
                }

                return { ntxValue, feeThreshold };
            }

            // 分析第三个API数据
            function analyzeThirdApi(data) {
                if (!data || !typeof data === 'object') {
                    throw new Error("第三个API数据无效或不是字典格式");
                }

                try {
                    // 检查是否有直接的USD字段
                    if ('USD' in data) {
                        return parseFloat(data.USD);
                    }

                    // 检查是否有prices子字典包含USD价格
                    if ('prices' in data && typeof data.prices === 'object' && 'USD' in data.prices) {
                        return parseFloat(data.prices.USD);
                    }

                    // 检查是否有rate字段包含USD价格
                    if ('rate' in data && typeof data.rate === 'object' && 'USD' in data.rate) {
                        return parseFloat(data.rate.USD);
                    }

                    console.log("未找到USD数值字段");
                    return null;

                } catch (error) {
                    console.log("USD数值格式无效");
                    return null;
                }
            }

            // 分析第四个API数据
            function analyzeFourthApi(data) {
                if (!data || typeof data !== 'object') {
                    console.log("第四个API数据无效或不是字典格式");
                    return null;
                }

                try {
                    // 提取listingPrice的值
                    if (data.code === 0 && "data" in data) {
                        const dataContent = data.data;
                        if ("records" in dataContent && dataContent.records.length > 0) {
                            const firstRecord = dataContent.records[0];
                            if ("listingPrice" in firstRecord) {
                                return parseFloat(firstRecord.listingPrice);
                            } else {
                                console.log("未找到listingPrice字段");
                            }
                        } else {
                            console.log("records列表为空或不存在");
                        }
                    } else {
                        console.log(`API返回错误，状态码：${data.code}，消息：${data.msg}`);
                    }
                } catch (error) {
                    console.log(`解析第四个API数据时发生错误：${error}`);
                }
                return null;
            }

            // 计算套利相关结果
            function calculateArbitrage(mintAmount, chainThreshold, qualifiedCount, usdValue, chaiyouPrice) {
                if (qualifiedCount <= 0 || !chaiyouPrice || !chainThreshold) {
                    return {
                        distributionRatio: null,
                        dieselAmount: null,
                        actualCostSats: null,
                        usdCost: null,
                        chaiyouValue: null,
                        profit: null,
                        returnRate: null
                    };
                }

                // 分配比例: mint数量/(fee字段大于等于阈值的数据条数 + mint数量)
                const distributionRatio = mintAmount / (qualifiedCount + mintAmount);

                // 获得柴油数量: 分配比例*3.125
                const dieselAmount = distributionRatio * 3.125;

                // 获得柴油价值: 获得柴油数量*柴油价格/100000000 * USD数值
                const chaiyouValue = usdValue ? (dieselAmount * chaiyouPrice / 100000000 * usdValue) : null;

                // 实际成本 (上链费率): mint数量 * 149 * 上链阈值
                const actualCostSats = mintAmount * 149 * chainThreshold;

                // USD成本 ：实际成本/100000000 * USD数值
                const usdCost = usdValue ? (actualCostSats / 100000000) * usdValue : null;

                // 利润计算
                const profit = chaiyouValue && usdCost ? chaiyouValue - usdCost : null;

                // 回报率计算: (利润 / 成本) * 100%
                const returnRate = profit && usdCost && usdCost !== 0 ? (profit / usdCost) * 100 : null;

                return {
                    distributionRatio,
                    dieselAmount,
                    actualCostSats,
                    usdCost,
                    chaiyouValue,
                    profit,
                    returnRate
                };
            }

            // 更新套利计算结果
            function updateArbitrageCalculation() {
                const { feeGeThresholdCount, usdValue, chaiyouPrice } = currentData;
                let mintAmount = parseInt(document.getElementById('quantity').value, 10) || 25;
                // 确保上链阈值保留两位小数
                let chainThreshold = parseFloat(document.getElementById('chainThreshold').value) || 1.00;
                chainThreshold = Math.round(chainThreshold * 100) / 100; // 确保两位小数精度

                // 确保mint数量为正数
                if (mintAmount <= 0) {
                    mintAmount = 25;
                    document.getElementById('quantity').value = 25;
                }

                // 确保上链阈值为正数
                if (chainThreshold <= 0) {
                    chainThreshold = 1.00;
                    document.getElementById('chainThreshold').value = 1.00;
                }

                // 更新显示的数量值
                document.getElementById('quantityDisplay').textContent = mintAmount;
                document.getElementById('quantityDisplay2').textContent = mintAmount;
                // 显示时保留两位小数
                document.getElementById('thresholdDisplay').textContent = chainThreshold.toFixed(2);

                // 更新分母值
                const denominator = feeGeThresholdCount + mintAmount;
                document.getElementById('distributionDenominator').textContent = denominator;

                // 计算套利结果
                const result = calculateArbitrage(mintAmount, chainThreshold, feeGeThresholdCount, usdValue, chaiyouPrice);

                // 更新UI显示
                document.getElementById('distributionRatio').textContent = result.distributionRatio ? formatNumber(result.distributionRatio) : '--';
                document.getElementById('ratioDisplay').textContent = result.distributionRatio ? formatNumber(result.distributionRatio) : '--';
                document.getElementById('dieselAmount').textContent = result.dieselAmount ? formatNumber(result.dieselAmount) : '--';
                document.getElementById('chaiyouValue').textContent = result.chaiyouValue ? `${formatNumber(result.chaiyouValue)} USD` : '-- USD';
                document.getElementById('actualCost').textContent = result.actualCostSats ? `${formatNumber(result.actualCostSats)} sats` : '-- sats';
                document.getElementById('usdCost').textContent = result.usdCost ? `${formatNumber(result.usdCost)} USD` : '-- USD';

                // 更新利润计算
                document.getElementById('profitValue').textContent = result.chaiyouValue ? `${formatNumber(result.chaiyouValue)} USD` : '--';
                document.getElementById('costValue').textContent = result.usdCost ? `${formatNumber(result.usdCost)} USD` : '--';
                document.getElementById('finalProfit').textContent = result.profit ? `${formatNumber(result.profit)} USD` : '--';

                // 更新回报率计算
                document.getElementById('finalProfitDisplay').textContent = result.profit ? `${formatNumber(result.profit)}` : '--';
                document.getElementById('usdCostDisplay').textContent = result.usdCost ? `${formatNumber(result.usdCost)}` : '--';
                document.getElementById('returnRate').textContent = result.returnRate !== null ? formatPercentage(result.returnRate) : '-- %';

                // 回报率容器元素
                const returnRateContainer = document.getElementById('returnRateContainer');
                // 移除之前的高亮效果
                returnRateContainer.classList.remove('alert-highlight');

                // 检查回报率是否大于50%，并且处于监控状态
                if (result.returnRate !== null && result.returnRate > 50 && isMonitoring) {
                    // 只有当回报率从低于50%升至高于50%时才触发通知
                    if (lastReturnRate === null || lastReturnRate <= 50) {
                        playAlertSound(); // 播放提示声音
                        showHighReturnAlert();
                        // 添加高亮动画
                        returnRateContainer.classList.add('alert-highlight');
                    }
                }

                // 保存当前回报率用于下次比较
                lastReturnRate = result.returnRate;

                // 根据利润值设置颜色
                if (result.profit !== null) {
                    const finalProfitEl = document.getElementById('finalProfit');
                    if (result.profit > 0) {
                        finalProfitEl.classList.add('text-green-500');
                        finalProfitEl.classList.remove('text-red-500');
                    } else if (result.profit < 0) {
                        finalProfitEl.classList.add('text-red-500');
                        finalProfitEl.classList.remove('text-green-500');
                    } else {
                        finalProfitEl.classList.remove('text-green-500', 'text-red-500');
                    }
                }

                // 根据回报率设置颜色
                if (result.returnRate !== null) {
                    const returnRateEl = document.getElementById('returnRate');
                    if (result.returnRate > 0) {
                        returnRateEl.classList.add('text-green-500');
                        returnRateEl.classList.remove('text-red-500');
                    } else if (result.returnRate < 0) {
                        returnRateEl.classList.add('text-red-500');
                        returnRateEl.classList.remove('text-green-500');
                    } else {
                        returnRateEl.classList.remove('text-green-500', 'text-red-500');
                    }
                }
            }

            // 更新UI显示
            function updateUI() {
                const { feeRanges, feeGeThresholdCount,
                        firstNtxValue, feeThreshold, usdValue, chaiyouPrice } = currentData;

                // 更新核心数据卡片
                document.getElementById('usdValue').textContent = usdValue !== null ? formatNumber(usdValue) : '未获取';
                document.getElementById('ntxValue').textContent = firstNtxValue !== null ? firstNtxValue : '未获取';
                // 确保阈值显示两位小数
                document.getElementById('feeThreshold').textContent = feeThreshold !== null ? parseFloat(feeThreshold).toFixed(2) : '未获取';
                document.getElementById('qualifiedCount').textContent = feeGeThresholdCount;
                document.getElementById('chaiyouPrice').textContent = chaiyouPrice !== null ? formatNumber(chaiyouPrice) : '未获取';

                // 更新fee分布详情
                document.getElementById('range0-1').textContent = feeRanges['0-1'];
                document.getElementById('range1-2').textContent = feeRanges['1-2'];
                document.getElementById('range2-3').textContent = feeRanges['2-3'];
                document.getElementById('range3plus').textContent = feeRanges['3以上'];
                document.getElementById('rangeInvalid').textContent = feeRanges['无效值'];
                document.getElementById('rangeNoFee').textContent = feeRanges['无fee字段'];
            }

            // 初始化应用
            initApp();
        });
    </script>
</body>
</html>






